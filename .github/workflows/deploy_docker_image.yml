deploy-docker-image:
  runs-on: ubuntu-latest
  needs: [build-and-publish-docker-image]  # requires successful completion
  steps:
    - name: Set up SSH connection to AWS remote server
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        mkdir ~/.ssh/
        echo "${SSH_KEY}" > ~/.ssh/key.pem
        chmod 400 ~/.ssh/key.pem
        cat >> ~/.ssh/config << END
        Host remote_host
          HostName ${SSH_HOST}
          User ${SSH_USERNAME}
          IdentityFile ~/.ssh/key.pem
          StrictHostKeyChecking no
        END
      
    - name: Deploy Docker container on AWS via SSH
      run: |  # Pre-requisite: docker has been installed on remote machine
        ssh remote_host "docker ps -a"                         # remote_host as defined in ~/.ssh/config
        ssh remote_host "docker ps -q | xargs -r docker stop"  # stops any running container
        ssh remote_host "docker pull ${IMAGE_NAME}"
        ssh remote_host "docker run -d -p 80:80 ${IMAGE_NAME}:latest"